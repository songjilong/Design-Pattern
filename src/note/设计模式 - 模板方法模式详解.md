# åŸºæœ¬ä»‹ç»

æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆTemplate Method Patternï¼‰ä¹Ÿå«æ¨¡æ¿æ¨¡å¼ï¼Œå®ƒåœ¨ä¸€ä¸ªæŠ½è±¡ç±»ä¸­å…¬å¼€å®šä¹‰äº†æ‰§è¡Œå®ƒçš„æ–¹æ³•çš„æ¨¡æ¿ï¼Œå®ƒçš„å­—ç±»å¯ä»¥æŒ‰éœ€é‡å†™æ–¹æ³•å®ç°ï¼Œä½†è°ƒç”¨å°†ä»¥æŠ½è±¡ç±»ä¸­å®šä¹‰çš„æ–¹å¼è¿›è¡Œã€‚

ç®€å•æ¥è¯´ï¼Œæ¨¡æ¿æ–¹æ³•æ¨¡å¼å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•çš„éª¨æ¶ï¼Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ï¼Œä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•çš„ç»“æ„ï¼Œå°±èƒ½é‡æ–°å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤

# æ¨¡å¼ç»“æ„

<img src="https://gitee.com/songjilong/FigureBed/raw/master/img/20200423142944.png" style="zoom:80%;" />

- AbstractClassï¼šæŠ½è±¡ç±»ï¼Œç±»ä¸­å®ç°äº†æ¨¡æ¿æ–¹æ³•ï¼Œå®šä¹‰äº†ç®—æ³•çš„éª¨æ¶

- ConcreteClassï¼šå®ç°ç±»ï¼Œç»§æ‰¿æŠ½è±¡ç±»ï¼Œé‡å†™å…¶ä¸­çš„æŠ½è±¡æ–¹æ³•

# ä¸¾ä¾‹è¯´æ˜

> ç¼–å†™ä¸€ä¸ªåˆ¶ä½œè±†æµ†çš„ç¨‹åº
>
> åˆ¶ä½œè±†æµ†çš„æµç¨‹ï¼šé€‰æï¼ˆé»„è±†ï¼‰ â†’ æ·»åŠ é…æ–™ï¼ˆï¼‰ â†’ æµ¸æ³¡ â†’ ç£¨è±†æµ†
>
> è¦æ±‚ï¼šé€šè¿‡æ·»åŠ ä¸åŒçš„é…æ–™ï¼Œå¯ä»¥åˆ¶ä½œå‡ºä¸åŒå£å‘³çš„è±†æµ†ï¼ˆé™¤äº†æ·»åŠ é…æ–™ä¸åŒï¼Œå…¶å®ƒæ­¥éª¤æ˜¯ç›¸åŒçš„ï¼‰

1ã€å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼ŒBaseSoyMilkï¼šè±†æµ†ç±»

```java
public abstract class BaseSoyMilk {
    /**
     * æ¨¡æ¿æ–¹æ³•ï¼Œåˆ¶ä½œè±†æµ†çš„æµç¨‹
     * å£°æ˜ä¸º finalï¼Œé˜²æ­¢å­ç±»é‡å†™
     */
    protected final void make() {
        select();
        addOther();
        soak();
        grind();
    }

    private void select() {
        System.out.println("é€‰æ‹©ä¸Šå¥½çš„é»„è±†");
    }

    protected abstract void addOther();

    private void soak() {
        System.out.println("æµ¸æ³¡åŸææ–™");
    }

    private void grind() {
        System.out.println("ç ”ç£¨æˆè±†æµ†");
    }
}
```

2ã€åˆ›å»ºå­ç±»ï¼ŒPeanutSoyMilkï¼šèŠ±ç”Ÿè±†æµ†

```java
public class PeanutSoyMilk extends BaseSoyMilk {
    @Override
    protected void addOther() {
        System.out.println("æ·»åŠ èŠ±ç”Ÿ");
    }
}
```

RedBeanSoyMilkï¼šçº¢è±†è±†æµ†

```java
public class RedBeanSoyMilk extends BaseSoyMilk {
    @Override
    protected void addOther() {
        System.out.println("æ·»åŠ çº¢è±†");
    }
}
```

3ã€åˆ›å»ºæµ‹è¯•ç±»ï¼šClient

```java
public class Client {
    @Test
    public void test() {
        BaseSoyMilk peanutSoyMilk = new PeanutSoyMilk();
        peanutSoyMilk.make();
        System.out.println("****************");
        BaseSoyMilk redBeanSoyMilk = new RedBeanSoyMilk();
        redBeanSoyMilk.make();
    }
}
```

4ã€è¿è¡Œç»“æœ

```
é€‰æ‹©ä¸Šå¥½çš„é»„è±†
æ·»åŠ èŠ±ç”Ÿ
æµ¸æ³¡åŸææ–™
ç ”ç£¨æˆè±†æµ†
************
é€‰æ‹©ä¸Šå¥½çš„é»„è±†
æ·»åŠ çº¢è±†
æµ¸æ³¡åŸææ–™
ç ”ç£¨æˆè±†æµ†
```

# é’©å­æ–¹æ³•

åœ¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„æŠ½è±¡ç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒé»˜è®¤ä¸åšä»»ä½•äº‹ï¼Œå­ç±»å¯ä»¥è§†æƒ…å†µæ¥å†³å®šæ˜¯å¦é‡å†™å®ƒï¼Œè¯¥æ–¹æ³•ç§°ä¸ºã€Œé’©å­ã€ã€‚

ä¾ç„¶ä»¥ä¸Šé¢åˆ¶ä½œè±†æµ†çš„ä¾‹å­æ¥è¯´æ˜ï¼Œå¦‚æœæˆ‘ä»¬ä»€ä¹ˆé…æ–™éƒ½ä¸æƒ³åŠ ï¼Œåˆ¶ä½œçº¯è±†æµ†ï¼Œå¯ä»¥ä½¿ç”¨é’©å­æ–¹æ³•å¯¹å…¶æ”¹é€ ã€‚

1ã€ä¸º `BaseSoyMilk` ç±»æ·»åŠ ä¸€ä¸ªæ–¹æ³• `isAdd` åˆ¤æ–­æ˜¯å¦æ·»åŠ å…¶å®ƒææ–™

```java
public abstract class BaseSoyMilk {
    /**
     * æ¨¡æ¿æ–¹æ³•ï¼Œåˆ¶ä½œè±†æµ†çš„æµç¨‹
     * å£°æ˜ä¸º finalï¼Œé˜²æ­¢å­ç±»é‡å†™
     */
    protected final void make() {
        select();
        if(isAdd()){
            addOther();
        }
        soak();
        grind();
    }

    private void select() {
        System.out.println("é€‰æ‹©ä¸Šå¥½çš„é»„è±†");
    }

    protected abstract void addOther();

    private void soak() {
        System.out.println("æµ¸æ³¡åŸææ–™");
    }

    private void grind() {
        System.out.println("ç ”ç£¨æˆè±†æµ†");
    }

    protected boolean isAdd(){
        return true;
    }
}
```

2ã€åˆ›å»ºä¸€ä¸ªå­ç±» PureSoyMilkï¼šçº¯è±†æµ†

```java
public class PureSoyMilk extends BaseSoyMilk {
    @Override
    protected void addOther() {
    }

    @Override
    protected boolean isAdd() {
        return false;
    }
}
```

3ã€æµ‹è¯•

```java
@Test
public void test2() {
    BaseSoyMilk pureSoyMilk = new PureSoyMilk();
    pureSoyMilk.make();
}
```

4ã€è¿è¡Œç»“æœï¼ˆç°åœ¨å°±æ²¡æœ‰æ·»åŠ å…¶å®ƒææ–™çš„æ­¥éª¤äº†ï¼‰

```
é€‰æ‹©ä¸Šå¥½çš„é»„è±†
æµ¸æ³¡åŸææ–™
ç ”ç£¨æˆè±†æµ†
```

# æ¨¡å¼åˆ†æ

**ğŸ‰ ä¼˜ç‚¹**

- ç®—æ³•åªå­˜åœ¨äºçˆ¶ç±»ä¸­ï¼Œæ˜“ä¿®æ”¹
- å®ç°äº†ä»£ç çš„å¤ç”¨æ€§ï¼Œçˆ¶ç±»çš„ä¸€äº›æ–¹æ³•ç›´æ¥è¢«å­ç±»ä½¿ç”¨
- æ—¢ç»Ÿä¸€äº†ç®—æ³•ï¼Œä¹Ÿä¿è¯äº†å¾ˆå¤§çš„çµæ´»æ€§

**ğŸ’£ ç¼ºç‚¹**

- æ¯ä¸€ä¸ªä¸åŒçš„å®ç°éƒ½éœ€è¦ä¸€ä¸ªå­ç±»æ¥å®ç°ï¼Œå¯¼è‡´ç±»çš„æ•°é‡å¢åŠ ï¼Œæ˜¯ç³»ç»Ÿæ›´åºå¤§

**ğŸ¯ æ³¨æ„äº‹é¡¹**

- ä¸€èˆ¬æ¨¡æ¿æ–¹æ³•è¦åŠ ä¸Š final ä¿®é¥°ç¬¦ï¼Œé˜²æ­¢å­ç±»é‡å†™

**ğŸ² ä½¿ç”¨åœºæ™¯**

- å½“æˆ‘ä»¬è¦å®ŒæˆæŸä¸ªè¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹æœ‰ä¸€ç³»åˆ—æ­¥éª¤ï¼Œè€Œä¸”è¿™äº›æ­¥éª¤åŸºæœ¬ç›¸åŒï¼Œåªæœ‰ä¸ªåˆ«æ­¥éª¤çš„å®ç°å¯èƒ½ä¸åŒï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼

# åœ¨ Spring æºç ä¸­çš„åº”ç”¨

æ¨¡æ¿æ–¹æ³•æ¨¡å¼åœ¨ Spring IOC å®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™æœ‰æ‰€åº”ç”¨ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ `AbstractApplicationContext` ä¸­çš„ `refresh` æ–¹æ³•ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨äº†ä¸€ç³»åˆ—æ–¹æ³•ï¼Œæœ‰ä»¥å®ç°çš„å…·ä½“æ–¹æ³•ï¼Œæœ‰æœªå®ç°çš„æŠ½è±¡æ–¹æ³•ï¼Œä¹Ÿæœ‰ç©ºçš„é’©å­æ–¹æ³•

```java
public void refresh() throws BeansException, IllegalStateException {
   synchronized (this.startupShutdownMonitor) {
      prepareRefresh();
       //æ­¤æ–¹æ³•å†…éƒ¨è°ƒç”¨äº†ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•refreshBeanFactory()å’ŒgetBeanFactory()
       //å…·ä½“è¦å–å“ªç§beanFactoryçš„æ§åˆ¶æƒäº¤ç»™äº†å­ç±»
      ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();
      prepareBeanFactory(beanFactory);
      try {
          //é’©å­æ–¹æ³•
         postProcessBeanFactory(beanFactory);
         invokeBeanFactoryPostProcessors(beanFactory);
         registerBeanPostProcessors(beanFactory);
         initMessageSource();
         initApplicationEventMulticaster();
          //é’©å­æ–¹æ³•
         onRefresh();
         registerListeners();
         finishBeanFactoryInitialization(beanFactory);
         finishRefresh();
      }
      catch (BeansException ex) {
         if (logger.isWarnEnabled()) {
            logger.warn("Exception encountered during context initialization - " +
                  "cancelling refresh attempt: " + ex);
         }
         destroyBeans();
         cancelRefresh(ex);
         throw ex;
      }
      finally {
         resetCommonCaches();
      }
   }
}
```

éƒ¨åˆ†ç»“æ„ç±»å›¾å¦‚ä¸‹

![](https://gitee.com/songjilong/FigureBed/raw/master/img/20200423170136.png)

